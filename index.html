<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaqwaTrack - Suivi d'objectifs</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Titillium+Web:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Container d'authentification -->
    <div id="auth-container" class="auth-container">
        <div class="auth-box">
            <div class="app-branding">
                <h1 class="app-name">TaqwaTrack</h1>
                <p class="app-slogan">Ma√Ætrise ton Nafs, accomplis tes objectifs</p>
            </div>
            
            <h2 id="auth-title">Connexion</h2>
            
            <form id="login-form" class="auth-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="votre@email.com" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Mot de passe</label>
                    <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <div id="login-error" class="error-message" style="display: none;"></div>
                <button type="button" id="login-submit" class="auth-button">Se connecter</button>
                <p class="auth-switch">Pas encore de compte? <a href="#" id="show-signup">Cr√©er un compte</a></p>
            </form>
            
            <form id="signup-form" class="auth-form" style="display: none;">
                <div class="form-group">
                    <label for="signup-username">Nom d'utilisateur</label>
                    <input type="text" id="signup-username" placeholder="Votre nom" required>
                </div>
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" placeholder="votre@email.com" required>
                </div>
                <div class="form-group">
                    <label for="signup-password">Mot de passe</label>
                    <input type="password" id="signup-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <div id="signup-error" class="error-message"></div>
                <button type="button" id="signup-submit" class="auth-button">Cr√©er un compte</button>
                <p class="auth-switch">D√©j√† un compte? <a href="#" id="show-login">Se connecter</a></p>
            </form>
            
            <!-- Bouton de mode hors ligne -->
            <div class="offline-option" style="margin-top: 20px; text-align: center;">
                <button id="offline-mode-btn" style="background: #333; color: #999; border: 1px solid #666; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
                    Mode hors ligne (sans compte)
                </button>
            </div>
        </div>
    </div>

    <!-- Conteneur principal de l'application -->
    <div class="app-container" style="display: none;">
        <header class="app-header">
            <h1 class="app-title">TAQWATRACK</h1>
            <div class="level-display">
                <div class="level-title">Niveau <span id="current-level">1</span></div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="xp-progress"></div>
                </div>
                <div class="xp-display" id="xp-count">0 XP</div>
            </div>
            <div id="debug-info" style="display: none; font-size: 10px; color: #666; margin-top: 5px;"></div>
        </header>

        <div class="tab-navigation">
            <button id="tab-daily" class="tab-btn active">Aujourd'hui</button>
            <button id="tab-progress" class="tab-btn">Progression</button>
            <button id="tab-stats" class="tab-btn">Stats</button>
        </div>

        <div class="tab-content-container">
            <div id="daily-tab" class="tab-content active">
                <h2>Suivi du <span id="current-date">1 avril</span></h2>
                <div id="daily-inputs" class="content-section"></div>
            </div>

            <div id="progress-tab" class="tab-content">
                <h2>Progression Globale</h2>
                <div class="category-selector">
                    <button data-category="personal" class="category-btn active" id="category-btn-personal">Perso</button>
                    <button data-category="professional" class="category-btn" id="category-btn-professional">Pro</button>
                </div>
                <div id="progress-container" class="content-section"></div>
            </div>

            <div id="stats-tab" class="tab-content">
                <h2>Vos Statistiques</h2>
                <div id="stats-container" class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üî•</div>
                        <div class="stat-value" id="current-streak">0</div>
                        <div class="stat-label">Jours cons√©cutifs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚≠ê</div>
                        <div class="stat-value" id="objectives-completed">0</div>
                        <div class="stat-label">Objectifs compl√©t√©s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="completion-percentage">0%</div>
                        <div class="stat-label">Progression totale</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üèÜ</div>
                        <div class="stat-value" id="best-streak">0</div>
                        <div class="stat-label">Meilleur streak</div>
                    </div>
                </div>
                <div class="achievements">
                    <h3>Badges d√©bloqu√©s</h3>
                    <div id="badges-container" class="badges-grid"></div>
                </div>
            </div>
        </div>
        
        <button id="logout-btn" class="logout-btn">
            Se d√©connecter
            <span class="tooltip">Si vous rencontrez des probl√®mes, utilisez la <a href="?logout=true">d√©connexion forc√©e</a></span>
        </button>
    </div>

    <div id="level-up-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal" class="close-modal">&times;</span>
            <h2>Niveau Sup√©rieur!</h2>
            <div class="level-up-icon">üéâ</div>
            <p>F√©licitations! Vous avez atteint le niveau <span id="new-level">2</span>!</p>
        </div>
    </div>

    <!-- Console de d√©bogage -->
    <div id="debug-console" style="position: fixed; bottom: 0; left: 0; right: 0; background: #111; color: #0f0; font-family: monospace; font-size: 12px; padding: 5px; max-height: 100px; overflow-y: auto; display: none;">
        <div id="objectives-debug">Chargement des objectifs...</div>
    </div>

    <!-- Import de la biblioth√®que Supabase - assurez-vous qu'elle est charg√©e en premier et non en module -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Script de d√©bogage pour les appareils mobiles -->
    <script>
        // Fonction pour afficher les erreurs de console sur mobile
        window.onerror = function(message, source, lineno, colno, error) {
            const debugConsole = document.getElementById('debug-console');
            debugConsole.style.display = 'block';
            debugConsole.innerHTML += `<p>ERREUR: ${message} (${source}:${lineno}:${colno})</p>`;
        };

        console.error = function(message) {
            const debugConsole = document.getElementById('debug-console');
            debugConsole.style.display = 'block';
            debugConsole.innerHTML += `<p>ERREUR CONSOLE: ${message}</p>`;
        };

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
              .then(reg => console.log('Service Worker registered', reg))
              .catch(err => console.error('Service Worker error', err));
        }
    </script>
    
    <!-- Import de nos scripts JavaScript -->
    <script type="module" src="supabase.js"></script>
    <script type="module" src="app.js"></script>

    <!-- Script pour activer la console de d√©bogage et d√©sactiver l'auto-connexion -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // 0. Forcer la d√©connexion si param√®tre dans l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const forceLogout = urlParams.get('logout');
        
        if (forceLogout === 'true') {
            console.log("D√©connexion forc√©e demand√©e par l'URL");
            
            // Supprimer toutes les cl√©s Supabase du localStorage
            let hasClearedKeys = false;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (
                    key.includes('supabase') || 
                    key.includes('sb-') || 
                    key.includes('supa') ||
                    key === 'challengeAvrilAppState'
                )) {
                    console.log("Suppression forc√©e de la cl√©:", key);
                    localStorage.removeItem(key);
                    hasClearedKeys = true;
                    i--; // Ajuster l'index car la liste a √©t√© modifi√©e
                }
            }
            
            if (hasClearedKeys) {
                // Afficher un message √† l'utilisateur
                const message = document.createElement('div');
                message.style.position = 'fixed';
                message.style.top = '50%';
                message.style.left = '50%';
                message.style.transform = 'translate(-50%, -50%)';
                message.style.background = 'rgba(0,0,0,0.8)';
                message.style.color = '#fff';
                message.style.padding = '20px';
                message.style.borderRadius = '10px';
                message.style.zIndex = '9999';
                message.style.textAlign = 'center';
                message.style.fontFamily = 'var(--body-font)';
                message.innerHTML = '<h3>D√©connexion forc√©e r√©ussie</h3><p>Vous allez √™tre redirig√© vers la page d\'accueil.</p>';
                document.body.appendChild(message);
                
                // Rediriger vers la page sans param√®tre apr√®s 2 secondes
                setTimeout(function() {
                    window.location.href = window.location.pathname;
                }, 2000);
            } else {
                // Rediriger vers la page sans param√®tre imm√©diatement
                window.location.href = window.location.pathname;
            }
            return; // Arr√™ter l'ex√©cution du reste du script
        }
        
        // 1. V√©rifier si plusieurs instances d'authentification sont pr√©sentes
        const authKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.includes('auth-token')) {
                authKeys.push(key);
            }
        }
        
        if (authKeys.length > 1) {
            console.warn("Plusieurs jetons d'authentification d√©tect√©s:", authKeys);
            // Garder seulement le plus r√©cent (si possible) ou tout nettoyer
            authKeys.slice(0, -1).forEach(key => {
                console.log("Suppression du jeton suppl√©mentaire:", key);
                localStorage.removeItem(key);
            });
        }
        
        // 2. D√©sactiver l'auto-connexion
        if (window.forceDisplayApp) {
            console.log("Mode automatique d√©sactiv√© - utilisation du bouton hors ligne");
            // Remplacer par une version qui ne s'ex√©cute que sur commande
            const originalFn = window.forceDisplayApp;
            window.forceDisplayApp = function() {
                console.log("Mode hors ligne activ√© manuellement");
                return originalFn.apply(this, arguments);
            };
        }
        
        // 3. Supprimer/masquer les messages d'erreur au d√©marrage
        const errorElements = document.querySelectorAll('.error-message');
        errorElements.forEach(el => {
            el.style.display = 'none';
            el.textContent = '';
        });
        
        // 4. Activer la console de d√©bogage en appuyant 5 fois sur le titre de l'application
        let tapCount = 0;
        document.querySelector('.app-title').addEventListener('click', function() {
            tapCount++;
            if (tapCount >= 5) {
                document.getElementById('debug-console').style.display = 'block';
                document.getElementById('debug-info').style.display = 'block';
                
                // Afficher des informations sur les objectifs
                const objectivesDebug = document.getElementById('objectives-debug');
                if (window.objectives) {
                    objectivesDebug.textContent = `Objectifs personnels: ${window.objectives.personal ? window.objectives.personal.length : 0}, Objectifs professionnels: ${window.objectives.professional ? window.objectives.professional.length : 0}`;
                } else {
                    objectivesDebug.textContent = "La variable 'objectives' n'est pas d√©finie";
                }
                
                // Ajouter un bouton de d√©connexion forc√©e √† la console de d√©bogage
                const logoutBtn = document.createElement('button');
                logoutBtn.textContent = "Forcer la d√©connexion";
                logoutBtn.style.marginTop = "5px";
                logoutBtn.style.padding = "2px 5px";
                logoutBtn.style.backgroundColor = "#300";
                logoutBtn.style.color = "#f00";
                logoutBtn.style.border = "1px solid #f00";
                logoutBtn.addEventListener('click', function() {
                    window.location.href = "?logout=true";
                });
                objectivesDebug.appendChild(document.createElement('br'));
                objectivesDebug.appendChild(logoutBtn);
                
                tapCount = 0;
            }
        });
    });
    </script>
</body>
</html> 